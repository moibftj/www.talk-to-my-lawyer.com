name: Security Scanner

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual workflow dispatch
  workflow_dispatch:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better git analysis
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Run Security Scanner
        run: node scripts/security-scan.js
        continue-on-error: false

      - name: Upload Security Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-report
          path: |
            security-report-*.txt
            security-report-*.json
          retention-days: 30

  # Additional security checks
  secret-scanning:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: |
          echo "Checking for critical vulnerabilities..."
          pnpm audit --json > audit-report.json || true
          
          # Count critical and high vulnerabilities
          CRITICAL=$(cat audit-report.json | grep -o '"severity":"critical"' | wc -l || echo "0")
          HIGH=$(cat audit-report.json | grep -o '"severity":"high"' | wc -l || echo "0")
          
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          
          if [ "$CRITICAL" -gt "0" ]; then
            echo "❌ Critical vulnerabilities found!"
            exit 1
          fi

      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: audit-report.json
          retention-days: 30

  # Code security analysis
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # Environment variable validation
  env-validation:
    name: Environment Configuration Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "❌ .env.example file not found!"
            exit 1
          fi
          echo "✅ .env.example found"

      - name: Verify .gitignore patterns
        run: |
          echo "Checking .gitignore for security patterns..."
          
          REQUIRED_PATTERNS=(
            ".env"
            ".env.local"
            ".env*.local"
            "*.key"
            "*.pem"
            "*_SECRETS*"
            "*_CREDENTIALS*"
          )
          
          MISSING=0
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "⚠️  Missing pattern in .gitignore: $pattern"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "❌ $MISSING required patterns missing from .gitignore"
            exit 1
          fi
          
          echo "✅ All required .gitignore patterns present"

      - name: Check for committed secrets
        run: |
          echo "Checking for accidentally committed sensitive files..."
          
          SENSITIVE_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.staging"
          )
          
          FOUND=0
          for file in "${SENSITIVE_FILES[@]}"; do
            if git ls-files | grep -q "^$file$"; then
              echo "❌ Sensitive file committed to git: $file"
              FOUND=$((FOUND + 1))
            fi
          done
          
          if [ $FOUND -gt 0 ]; then
            echo "❌ $FOUND sensitive file(s) found in git history"
            exit 1
          fi
          
          echo "✅ No sensitive files committed to git"

  # Summary job
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, secret-scanning, dependency-scan, codeql-analysis, env-validation]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "Security Scan Results:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "CodeQL Analysis: ${{ needs.codeql-analysis.result }}"
          echo "Environment Validation: ${{ needs.env-validation.result }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Check if any critical jobs failed
          if [ "${{ needs.security-scan.result }}" == "failure" ] || \
             [ "${{ needs.secret-scanning.result }}" == "failure" ] || \
             [ "${{ needs.env-validation.result }}" == "failure" ]; then
            echo "❌ Critical security checks failed!"
            exit 1
          fi
          
          echo "✅ All critical security checks passed"
